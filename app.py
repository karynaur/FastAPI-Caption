import torch
import clip
from PIL import Image
import requests
import random

words = ['able',
 'abnormal',
 'above',
 'average',
 'absent-minded',
 'adventurous',
 'affectionate',
 'agile',
 'agreeable',
 'alert',
 'amazing',
 'ambitious',
 'amiable',
 'amusing',
 'analytical',
 'angelic',
 'apathetic',
 'apprehensive',
 'ardent',
 'artificial',
 'artistic',
 'assertive',
 'attentive',
 'average',
 'awesome',
 'awful',
 'balanced',
 'beautiful',
 'below',
 'average',
 'beneficent',
 'blue',
 'blunt',
 'boisterous',
 'brave',
 'bright',
 'brilliant',
 'buff',
 'callous',
 'candid',
 'cantankerous',
 'capable',
 'careful',
 'careless',
 'caustic',
 'cautious',
 'charming',
 'cheerful',
 'chic',
 'childish',
 'childlike',
 'churlish',
 'circumspect',
 'civil',
 'clean',
 'clever',
 'clumsy',
 'coherent',
 'cold',
 'competent',
 'composed',
 'conceited',
 'condescending',
 'confident',
 'confused',
 'conscientious',
 'considerate',
 'content',
 'cool',
 'cool-headed',
 'cooperative',
 'cordial',
 'courageous',
 'cowardly',
 'crabby',
 'crafty',
 'cranky',
 'crass',
 'critical',
 'cruel',
 'curious',
 'cynical',
 'dainty',
 'decisive',
 'deep',
 'deferential',
 'deft',
 'delicate',
 'delightful',
 'demonic',
 'demure',
 'dependent',
 'depressed',
 'devoted',
 'dextrous',
 'diligent',
 'direct',
 'dirty',
 'disagreeable',
 'discerning',
 'discreet',
 'disruptive',
 'distant',
 'distraught',
 'distrustful',
 'dowdy',
 'dramatic',
 'dreary',
 'drowsy',
 'drugged',
 'drunk',
 'dull',
 'dutiful',
 'eager',
 'earnest',
 'easy-going',
 'efficient',
 'egotistical',
 'elfin',
 'emotional',
 'energetic',
 'enterprising',
 'enthusiastic',
 'evasive',
 'even-tempered',
 'exacting',
 'excellent',
 'excitable',
 'experienced',
 'fabulous',
 'fastidious',
 'ferocious',
 'fervent',
 'fiery',
 'flabby',
 'flaky',
 'flashy',
 'frank',
 'friendly',
 'funny',
 'fussy',
 'generous',
 'gentle',
 'gloomy',
 'gluttonous',
 'good',
 'grave',
 'great',
 'groggy',
 'grouchy',
 'guarded',
 'hateful',
 'hearty',
 'helpful',
 'hesitant',
 'hot-headed',
 'hypercritical',
 'hysterical',
 'idiotic',
 'idle',
 'illogical',
 'imaginative',
 'immature',
 'immodest',
 'impatient',
 'imperturbable',
 'impetuous',
 'impractical',
 'impressionable',
 'impressive',
 'impulsive',
 'inactive',
 'incisive',
 'incompetent',
 'inconsiderate',
 'inconsistent',
 'indefatigable',
 'independent',
 'indiscreet',
 'indolent',
 'industrious',
 'inexperienced',
 'insensitive',
 'inspiring',
 'intelligent',
 'interesting',
 'intolerant',
 'inventive',
 'irascible',
 'irritable',
 'irritating',
 'jocular',
 'jovial',
 'joyous',
 'judgmental',
 'keen',
 'kind',
 'lame',
 'lazy',
 'lean',
 'leery',
 'lethargic',
 'level-headed',
 'listless',
 'lithe',
 'lively',
 'local',
 'logical',
 'long-winded',
 'lovable',
 'love-lorn',
 'lovely',
 'maternal',
 'mature',
 'mean',
 'meddlesome',
 'mercurial',
 'methodical',
 'meticulous',
 'mild',
 'miserable',
 'modest',
 'moronic',
 'morose',
 'motivated',
 'musical',
 'naive',
 'nasty',
 'natural',
 'naughty',
 'negative',
 'nervous',
 'noisy',
 'normal',
 'nosy',
 'numb',
 'obliging',
 'obnoxious',
 'old-fashioned',
 'one-sided',
 'orderly',
 'ostentatious',
 'outgoing',
 'outspoken',
 'passionate',
 'passive',
 'paternal',
 'paternalistic',
 'patient',
 'peaceful',
 'peevish',
 'pensive',
 'persevering',
 'persnickety',
 'petulant',
 'picky',
 'plain',
 'plain-speaking',
 'playful',
 'pleasant',
 'plucky',
 'polite',
 'popular',
 'positive',
 'powerful',
 'practical',
 'prejudiced',
 'pretty',
 'proficient',
 'proud',
 'provocative',
 'prudent',
 'punctual',
 'quarrelsome',
 'querulous',
 'quick',
 'quick-tempered',
 'quiet',
 'realistic',
 'reassuring',
 'reclusive',
 'reliable',
 'reluctant',
 'resentful',
 'reserved',
 'resigned',
 'resourceful',
 'respected',
 'respectful',
 'responsible',
 'restless',
 'revered',
 'ridiculous',
 'sad',
 'sassy',
 'saucy',
 'sedate',
 'self-assured',
 'selfish',
 'sensible',
 'sensitive',
 'sentimental',
 'serene',
 'serious',
 'sharp',
 'short-tempered',
 'shrewd',
 'shy',
 'silly',
 'sincere',
 'sleepy',
 'slight',
 'sloppy',
 'slothful',
 'slovenly',
 'slow',
 'smart',
 'snazzy',
 'sneering',
 'snobby',
 'sober',
 'somber',
 'sophisticated',
 'soulful',
 'soulless',
 'sour',
 'spirited',
 'spiteful',
 'stable',
 'staid',
 'steady',
 'stern',
 'stoic',
 'striking',
 'strong',
 'stupid',
 'sturdy',
 'subtle',
 'sulky',
 'sullen',
 'supercilious',
 'superficial',
 'surly',
 'suspicious',
 'sweet',
 'tactful',
 'tactless',
 'talented',
 'testy',
 'thinking',
 'thoughtful',
 'thoughtless',
 'timid',
 'tired',
 'tolerant',
 'touchy',
 'tranquil',
 'ugly',
 'unaffected',
 'unbalanced',
 'uncertain',
 'uncooperative',
 'undependable',
 'unemotional',
 'unfriendly',
 'unguarded',
 'unhelpful',
 'unimaginative',
 'unmotivated',
 'unpleasant',
 'unpopular',
 'unreliable',
 'unsophisticated',
 'unstable',
 'unsure',
 'unthinking',
 'unwilling',
 'venal',
 'versatile',
 'vigilant',
 'volcanic',
 'vulnerable',
 'warm',
 'warmhearted',
 'wary',
 'watchful',
 'weak',
 'well-behaved',
 'well-developed',
 'well-intentioned',
 'well-respected',
 'well-rounded',
 'willing',
 'wonderful',
 'zealous',
 'attractive',
 'youthful',
 'bald',
 'beautiful',
 'blonde',
 'gorgeous',
 'handsome',
 'large',
 'muscular',
 'ordinary',
 'plain',
 'presentable',
 'redhead',
 'scruffy',
 'shapely',
 'short',
 'skinny',
 'smart',
 'stocky',
 'tall',
 'tattooed',
 'thin',
 'unkempt',
 'well-built']


device = "cuda" if torch.cuda.is_available() else "cpu"
text = clip.tokenize(words).to(device)
model, preprocess = clip.load("ViT-B/32", device=device)




def get_words(image_bytes):

    qualities = []
    image = preprocess(Image.open(image_bytes)).unsqueeze(0).to(device)
    
    with torch.no_grad():
        
        
        probs = model(image, text)[0].softmax(dim=-1)
        topk = torch.topk(probs, 5)
        for i in topk.indices.cpu().numpy()[0]:
            qualities.append(words[i])
    return random.sample(qualities, 3)

def get_phrase_from_words(word_list, temperature=1.0, top_p=0.9, max_len=40):
    context = f"""Question: Using the words creative, versatile  and caring describe a person in one sentence:
    Answer: A creative person that curates unique content and cares for the people.
    Question: Using the words {word_list[0]}, {word_list[1]} and {word_list[2]} describe a person in one sentence:
    Answer:"""
    payload = {
        "context": context,
        "token_max_length": max_len,
        "temperature": temperature,
        "top_p": top_p,
    }
    response = requests.post("http://api.vicgalle.net:5000/generate", params=payload).json()
    return f"{response['text'].splitlines()[0]}".replace("  "," ")
    

